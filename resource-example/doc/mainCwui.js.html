<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>mainCwui.js - Documentation</title><meta property="og:title" content=""/><meta property="og:type" content="website"/><meta property="og:image" content=""/><meta property="og:url" content=""/><script src="scripts/prettify/prettify.js"></script><script src="scripts/prettify/lang-css.js"></script><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><link type="text/css" rel="stylesheet" href="styles/prettify.css"><link type="text/css" rel="stylesheet" href="styles/jsdoc.css"><script src="scripts/nav.js" defer></script><meta name="viewport" content="width=device-width, initial-scale=1.0"></head><body><input type="checkbox" id="nav-trigger" class="nav-trigger" /><label for="nav-trigger" class="navicon-button x"><div class="navicon"></div></label><label for="nav-trigger" class="overlay"></label><nav class="wrap"><input type="text" id="nav-search" placeholder="Search" /><h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ArrayExtd.html">ArrayExtd</a><ul class='methods'><li data-type='method' title='get of ArrayExtd'  style='display: none;'><a href="ArrayExtd.html#get">get</a></li></ul></li><li><a href="Cr.html">Cr</a><ul class='methods'><li data-type='method' title='dataSize of Cr'  style='display: none;'><a href="Cr.html#.dataSize">dataSize</a></li><li data-type='method' title='getFile of Cr'  style='display: none;'><a href="Cr.html#.getFile">getFile</a></li><li data-type='method' title='importScript of Cr'  style='display: none;'><a href="Cr.html#.importScript">importScript</a></li></ul></li><li><a href="cwui.html">cwui</a><ul class='members'><li data-type='member' style='display: none;'><a href="cwui.html#.activateKeyEvents">activateKeyEvents</a></li><li data-type='member' style='display: none;'><a href="cwui.html#.customRoutines">customRoutines</a></li><li data-type='member' style='display: none;'><a href="cwui.html#.fileCache">fileCache</a></li><li data-type='member' style='display: none;'><a href="cwui.html#.imagesUrl">imagesUrl</a></li><li data-type='member' style='display: none;'><a href="cwui.html#.pageTransition">pageTransition</a></li><li data-type='member' style='display: none;'><a href="cwui.html#.resizables">resizables</a></li><li data-type='member' style='display: none;'><a href="cwui.html#.trackedEvents">trackedEvents</a></li><li data-type='member' style='display: none;'><a href="cwui.html#.transitions">transitions</a></li><li data-type='member' style='display: none;'><a href="cwui.html#.vKeyboard">vKeyboard</a></li></ul><ul class='methods'><li data-type='method' title='_AddEvent of cwui'  style='display: none;'><a href="cwui.html#._AddEvent">_AddEvent</a></li><li data-type='method' title='_ClearFingerActions of cwui'  style='display: none;'><a href="cwui.html#._ClearFingerActions">_ClearFingerActions</a></li><li data-type='method' title='_ClearImageFrameRate of cwui'  style='display: none;'><a href="cwui.html#._ClearImageFrameRate">_ClearImageFrameRate</a></li><li data-type='method' title='_eventExist of cwui'  style='display: none;'><a href="cwui.html#._eventExist">_eventExist</a></li><li data-type='method' title='_GetRoutine of cwui'  style='display: none;'><a href="cwui.html#._GetRoutine">_GetRoutine</a></li><li data-type='method' title='_InitNewPage of cwui'  style='display: none;'><a href="cwui.html#._InitNewPage">_InitNewPage</a></li><li data-type='method' title='_NeutralizePageEvents of cwui'  style='display: none;'><a href="cwui.html#._NeutralizePageEvents">_NeutralizePageEvents</a></li><li data-type='method' title='_performWhenAllImgsLoaded of cwui'  style='display: none;'><a href="cwui.html#._performWhenAllImgsLoaded">_performWhenAllImgsLoaded</a></li><li data-type='method' title='_prepareTransition of cwui'  style='display: none;'><a href="cwui.html#._prepareTransition">_prepareTransition</a></li><li data-type='method' title='_RemoveEvent of cwui'  style='display: none;'><a href="cwui.html#._RemoveEvent">_RemoveEvent</a></li><li data-type='method' title='_RemovePreviousPage of cwui'  style='display: none;'><a href="cwui.html#._RemovePreviousPage">_RemovePreviousPage</a></li><li data-type='method' title='_SetImageURL of cwui'  style='display: none;'><a href="cwui.html#._SetImageURL">_SetImageURL</a></li><li data-type='method' title='_Transition__cross_fade of cwui'  style='display: none;'><a href="cwui.html#._Transition__cross_fade">_Transition__cross_fade</a></li><li data-type='method' title='_Transition__fade_to_black of cwui'  style='display: none;'><a href="cwui.html#._Transition__fade_to_black">_Transition__fade_to_black</a></li><li data-type='method' title='addCustom of cwui'  style='display: none;'><a href="cwui.html#.addCustom">addCustom</a></li><li data-type='method' title='bindVKeyboard of cwui'  style='display: none;'><a href="cwui.html#.bindVKeyboard">bindVKeyboard</a></li><li data-type='method' title='cancelConnect of cwui'  style='display: none;'><a href="cwui.html#.cancelConnect">cancelConnect</a></li><li data-type='method' title='getById of cwui'  style='display: none;'><a href="cwui.html#.getById">getById</a></li><li data-type='method' title='onKeyDown of cwui'  style='display: none;'><a href="cwui.html#.onKeyDown">onKeyDown</a></li><li data-type='method' title='onKeyUp of cwui'  style='display: none;'><a href="cwui.html#.onKeyUp">onKeyUp</a></li><li data-type='method' title='registerElements of cwui'  style='display: none;'><a href="cwui.html#.registerElements">registerElements</a></li><li data-type='method' title='reloadStyleSheets of cwui'  style='display: none;'><a href="cwui.html#.reloadStyleSheets">reloadStyleSheets</a></li><li data-type='method' title='resizeAll of cwui'  style='display: none;'><a href="cwui.html#.resizeAll">resizeAll</a></li><li data-type='method' title='setInnerHTML of cwui'  style='display: none;'><a href="cwui.html#.setInnerHTML">setInnerHTML</a></li><li data-type='method' title='showDialog of cwui'  style='display: none;'><a href="cwui.html#.showDialog">showDialog</a></li><li data-type='method' title='userCallback of cwui'  style='display: none;'><a href="cwui.html#.userCallback">userCallback</a></li><li data-type='method' title='_BodyTransition of cwui'  style='display: none;'><a href="cwui.html#_BodyTransition">_BodyTransition</a></li></ul></li><li><a href="documentExtd.html">documentExtd</a><ul class='methods'><li data-type='method' title='transformXHTMLToDom of documentExtd'  style='display: none;'><a href="documentExtd.html#.transformXHTMLToDom">transformXHTMLToDom</a></li></ul></li><li><a href="FileCache.html">FileCache</a><ul class='methods'><li data-type='method' title='load of FileCache'  style='display: none;'><a href="FileCache.html#load">load</a></li></ul></li><li><a href="FingerActions.html">FingerActions</a><ul class='methods'><li data-type='method' title='Bind of FingerActions'  style='display: none;'><a href="FingerActions.html#Bind">Bind</a></li><li data-type='method' title='Clear of FingerActions'  style='display: none;'><a href="FingerActions.html#Clear">Clear</a></li></ul></li><li><a href="GenericCache.html">GenericCache</a><ul class='methods'><li data-type='method' title='get of GenericCache'  style='display: none;'><a href="GenericCache.html#get">get</a></li></ul></li><li><a href="HTMLElementExtd.html">HTMLElementExtd</a><ul class='members'><li data-type='member' style='display: none;'><a href="HTMLElementExtd.html#.innerXHTML">innerXHTML</a></li></ul><ul class='methods'><li data-type='method' title='appendChildNodes of HTMLElementExtd'  style='display: none;'><a href="HTMLElementExtd.html#appendChildNodes">appendChildNodes</a></li><li data-type='method' title='getJs of HTMLElementExtd'  style='display: none;'><a href="HTMLElementExtd.html#getJs">getJs</a></li><li data-type='method' title='getParentByCssSelector of HTMLElementExtd'  style='display: none;'><a href="HTMLElementExtd.html#getParentByCssSelector">getParentByCssSelector</a></li><li data-type='method' title='moveStyleSheet of HTMLElementExtd'  style='display: none;'><a href="HTMLElementExtd.html#moveStyleSheet">moveStyleSheet</a></li><li data-type='method' title='nextSiblingByCssSelector of HTMLElementExtd'  style='display: none;'><a href="HTMLElementExtd.html#nextSiblingByCssSelector">nextSiblingByCssSelector</a></li><li data-type='method' title='nextSiblingByTagName of HTMLElementExtd'  style='display: none;'><a href="HTMLElementExtd.html#nextSiblingByTagName">nextSiblingByTagName</a></li><li data-type='method' title='previousSiblingByCssSelector of HTMLElementExtd'  style='display: none;'><a href="HTMLElementExtd.html#previousSiblingByCssSelector">previousSiblingByCssSelector</a></li><li data-type='method' title='previousSiblingByTagName of HTMLElementExtd'  style='display: none;'><a href="HTMLElementExtd.html#previousSiblingByTagName">previousSiblingByTagName</a></li><li data-type='method' title='removeComments of HTMLElementExtd'  style='display: none;'><a href="HTMLElementExtd.html#removeComments">removeComments</a></li></ul></li><li><a href="ImageFrameRate.html">ImageFrameRate</a><ul class='methods'><li data-type='method' title='Clear of ImageFrameRate'  style='display: none;'><a href="ImageFrameRate.html#Clear">Clear</a></li><li data-type='method' title='Set of ImageFrameRate'  style='display: none;'><a href="ImageFrameRate.html#Set">Set</a></li></ul></li><li><a href="mainCwui.html">mainCwui</a><ul class='methods'><li data-type='method' title='_BodyTransition of mainCwui'  style='display: none;'><a href="mainCwui.html#_BodyTransition">_BodyTransition</a></li><li data-type='method' title='execCommand of mainCwui'  style='display: none;'><a href="mainCwui.html#execCommand">execCommand</a></li><li data-type='method' title='initWebSock of mainCwui'  style='display: none;'><a href="mainCwui.html#initWebSock">initWebSock</a></li></ul></li><li><a href="OverlayCanvas.html">OverlayCanvas</a><ul class='methods'><li data-type='method' title='circle of OverlayCanvas'  style='display: none;'><a href="OverlayCanvas.html#circle">circle</a></li><li data-type='method' title='circleAlpha of OverlayCanvas'  style='display: none;'><a href="OverlayCanvas.html#circleAlpha">circleAlpha</a></li><li data-type='method' title='clear of OverlayCanvas'  style='display: none;'><a href="OverlayCanvas.html#clear">clear</a></li><li data-type='method' title='path of OverlayCanvas'  style='display: none;'><a href="OverlayCanvas.html#path">path</a></li><li data-type='method' title='rectAlpha of OverlayCanvas'  style='display: none;'><a href="OverlayCanvas.html#rectAlpha">rectAlpha</a></li><li data-type='method' title='rectangle of OverlayCanvas'  style='display: none;'><a href="OverlayCanvas.html#rectangle">rectangle</a></li><li data-type='method' title='resize of OverlayCanvas'  style='display: none;'><a href="OverlayCanvas.html#resize">resize</a></li><li data-type='method' title='text of OverlayCanvas'  style='display: none;'><a href="OverlayCanvas.html#text">text</a></li></ul></li><li><a href="StringExtd.html">StringExtd</a><ul class='methods'><li data-type='method' title='isHTML of StringExtd'  style='display: none;'><a href="StringExtd.html#isHTML">isHTML</a></li><li data-type='method' title='splice of StringExtd'  style='display: none;'><a href="StringExtd.html#splice">splice</a></li></ul></li><li><a href="Vector.html">Vector</a><ul class='methods'><li data-type='method' title='Amplitude of Vector'  style='display: none;'><a href="Vector.html#Amplitude">Amplitude</a></li><li data-type='method' title='BaryCenter of Vector'  style='display: none;'><a href="Vector.html#BaryCenter">BaryCenter</a></li><li data-type='method' title='DotProd of Vector'  style='display: none;'><a href="Vector.html#DotProd">DotProd</a></li><li data-type='method' title='IsNull of Vector'  style='display: none;'><a href="Vector.html#IsNull">IsNull</a></li><li data-type='method' title='Normalize of Vector'  style='display: none;'><a href="Vector.html#Normalize">Normalize</a></li><li data-type='method' title='Substract of Vector'  style='display: none;'><a href="Vector.html#Substract">Substract</a></li></ul></li><li><a href="VirtualKeyboard.html">VirtualKeyboard</a><ul class='methods'><li data-type='method' title='Bind of VirtualKeyboard'  style='display: none;'><a href="VirtualKeyboard.html#Bind">Bind</a></li><li data-type='method' title='Map of VirtualKeyboard'  style='display: none;'><a href="VirtualKeyboard.html#Map">Map</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#autoReplaceVariables">autoReplaceVariables</a></li><li><a href="global.html#CWUI">CWUI</a></li><li><a href="global.html#dataSize">dataSize</a></li><li><a href="global.html#delegate">delegate</a></li><li><a href="global.html#downloadAsFile">downloadAsFile</a></li><li><a href="global.html#escapeHtml">escapeHtml</a></li><li><a href="global.html#getCustomStyles">getCustomStyles</a></li><li><a href="global.html#getMock">getMock</a></li><li><a href="global.html#loadFile">loadFile</a></li><li><a href="global.html#loadFileAsync">loadFileAsync</a></li><li><a href="global.html#replaceVariables">replaceVariables</a></li></ul></nav><div id="main"><h1 class="page-title">mainCwui.js</h1><section><article><pre class="prettyprint source linenums"><code>/**
 * Created by jetbrains web development IDE ( Web/PhpStorm ).
 * Project: mySpineNav - spineNav
 * User: Pascal Gaudin
 * Mail: pascal.gaudin@zimmerbiomet.com
 * Date: 31/12/2020
 * Time: 14:45
 */

/**
 * class mainCwui
 * @extends  cwui
 */
class mainCwui extends cwui {

	/**
	 * constructor
	 *
	 * @constructor
	 */
	constructor() {
		super();

		Cr.getFile("{cwui_context}.json", false,
				   (_content) => {
					   this.initWebSock(_content);
					   // shutdown
					   var shutdownEventName = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? "pagehide" : "beforeunload";
					   window.addEventListener(shutdownEventName, cwui.webSock.send.bind(null,
																						 JSON.stringify({"command": "onWindowClose"})));

					   // element resize
					   window.addEventListener("resize", cwui.resizeAll);
				   });


	}

	/**
	 * WebSocket &amp; general initialisation
	 *
	 * @param _content
	 */
	initWebSock(_content) {

		// set JSON context
		cwui.context = JSON.parse(_content);

		// web-socket initialisation
		var webSocketCreated = false;
		cwui.webSock = new WebSocket("ws://" + cwui.context.wsAddress, "JSON+binary");


		// check for websocket validity
		if (!("WebSocket" in window))
			console.error("HTML5 WebSocket not supported!");

		// binary receive
		cwui.webSock.binaryType = "blob";


		// on web socket open
		cwui.webSock.addEventListener("open", () => {
			webSocketCreated = true;
		});


		// on web socket closure: close the window
		cwui.webSock.addEventListener("close", () => {
			if (!webSocketCreated)
				return cwui.showDialog("Sorry but your web-browser seems" +
									   " incompatible with protocoled web-socket usage...&lt;br>" +
									   "Please try with a web-kit compatible application" +
									   " (Chrome/Chromium, Edge, Opera...).");
			cwui.showDialog("user interface shutdowned");
			delegate(() => {
				window.close(); // depends of the browser...
			});
		});


		// element resize
		window.addEventListener("resize", cwui.resizeAll);
		// on web socket command reception
		cwui.webSock.addEventListener("message", (_cmd) => {		// binary or text receive
			var cmd = cwui.binaryRcv ? cwui.binaryRcv : JSON.parse(_cmd.data);
			if (cwui.binaryRcv) cmd.content = _cmd.data;
			this.execCommand(cmd);
		});

	}

	/**
	 * Perform action depending of the command
	 *
	 * @param cmd
	 */
	execCommand(cmd) {
		switch (cmd.command) {
			// set the current body
			case "setBody":
				this._BodyTransition(
					cmd.data,
					cmd.readOnly,
					cmd.transition);
				break;

			// set document title
			case "setTitle":
				document.title = cmd.data;
				break;

			// resize the window
			case "resize":
				window.resizeTo(
					cmd.data.width,
					cmd.data.height);
				break;

			// set the html of a given element
			case "setHtml":
				cwui.getById(cmd.data.id).innerHTML = cmd.data.value;
				break;

			// set a css property of a given element
			case "setCss":
				cwui.getById(cmd.data.id).style[cmd.data.property] = cmd.data.value;
				break;

			// get a css property of a given element
			case "getCss":
				var telement = document.createElement("div");
				telement.classList.add(cmd.data.className);
				document.body.appendChild(telement);
				var value = window.getComputedStyle(telement,
													null).getPropertyValue(cmd.data.property).trim();
				telement.remove();
				cwui.webSock.send(JSON.stringify({
													 "command"  : "onGetCss",
													 "className": cmd.data.className,
													 "property" : cmd.data.property,
													 "value"    : value
												 }));
				break;

			// action over the classList of a given element
			case "classList":
				var element = cwui.getById(cmd.data.id);
				if (cmd.data.action == "add")
					element.classList.add(cmd.data.name)
				else element.classList.remove(cmd.data.name);
				break;

			// set an image with binary content
			case "setImageFile":
				cwui.getById(cmd.data.id);
				// next message on websocket will be the binary content of the image file
				cwui.binaryRcv = {
					command: "setBinaryImage",
					data   : {id: cmd.data.id}
				};
				break;


			// receive and display binary image
			case "setBinaryImage":
				cwui.binaryRcv = null;
				cwui._SetImageURL(
					cmd.data.id,
					cmd.content);
				cwui.imageFrameRate.Set(cmd.data.id);
				break;

			// set the attribute of a given element
			case "setAttribute":
				var element = cwui.getById(cmd.data.id);
				element.setAttribute(
					cmd.data.name,
					cmd.data.value);
				break;

			// onKeyPress
			case "onKeyPress":
				cwui.activateKeyEvents = true;
				break;
			// set an action to a given element
			case "setAction":
				var element = cwui.getById(
					cmd.data.id, false);
				if (!element) // may be KO because of asynchronous DOM manipulations
					return;
				switch (cmd.data.action) {
					// onMouseClick
					case "onMouseClick":
						cwui._AddEvent(element, "click", (_event) => {
							if (element.id == "") return;
							cwui.webSock.send(JSON.stringify(
								{
									"command": "onMouseClick",
									"id"     : element.id
								}));
							_event.stopPropagation();
						});
						break;

					// onMouseWheel
					case "onMouseWheel":
						cwui._AddEvent(element, "wheel", (_event) => {
							if (element.id == "")
								return;
							cwui.webSock.send(JSON.stringify(
								{
									"command": "onMouseWheel",
									"id"     : element.id,
									"delta"  : _event.deltaY
								}));
							_event.stopPropagation();
						});
						break;

					// onFingerAction
					case "onFingerAction":
						cwui.fingerActions.Bind(element, {
							onPick           : (_pick) => {
								cwui.webSock.send(JSON.stringify(
									{
										"command" : "onFingerPick",
										"id"      : cmd.data.id,
										"position": _pick.position
									}));
							},
							onGestureProgress: (_gesture) => {
								cwui.webSock.send(JSON.stringify({
																	 "command": "onFingerGestureProgress",
																	 "id"     : cmd.data.id,
																	 "gesture": _gesture
																 }));
							},
							onGestureEnd     : (_gesture) => {
								cwui.webSock.send(JSON.stringify(
									{
										"command": "onFingerGestureEnd",
										"id"     : cmd.data.id,
										"gesture": _gesture
									}));
							}
						});
						break;

					// onEdit
					case "onEdit":
						element.setAttribute("contenteditable", "true");
						cwui._AddEvent(element, "blur", () => {
							cwui.webSock.send(JSON.stringify({
																 "command": "onEditDone",
																 "id"     : element.id,
																 "data"   : element.outerHTML
															 }));
						});
						cwui._AddEvent(element, "keypress", (_event) => {
							if (_event.keyCode == 13) {
								element.dispatchEvent(new Event("blur"));
								return _event.preventDefault();
							}
							cwui.webSock.send(JSON.stringify({
																 "command": "onEditChange",
																 "id"     : element.id,
																 "data"   : element.outerHTML
															 }));
						});
						break;

					// onInput
					case "onInput":
						cwui._AddEvent(element, "input", (_event) => {
							cwui.webSock.send(JSON.stringify({
																 "command": "onInput",
																 "id"     : element.id,
																 "data"   : element.value
															 }));
							_event.stopPropagation();
						});
						break;

					// onResize
					case "onResize":
						cwui._AddEvent(element, "resize", (_event) => {
							if (_event.target.clientWidth != undefined &amp;&amp;
								_event.target.clientHeight != undefined)
								cwui.webSock.send(JSON.stringify({
																	 "command": "onResize",
																	 "id"     : cmd.data.id,
																	 "width"  : _event.target.clientWidth,
																	 "height" : _event.target.clientHeight
																 }));
							return false;
						});
						cwui.resizables.push(cmd.data.id);
						element.dispatchEvent(new Event("resize"));
						break;

					// onChange
					case "onChange":
						cwui._AddEvent(element, "change", (_event) => {
							cwui.webSock.send(JSON.stringify(
								{
									"command": "onChange",
									"id"     : element.id,
									"data"   : element.value
								}));
							_event.stopPropagation();
						});
						break;
					// unknown action
					default:
						console.error("Unknown action: " + cmd.data.action);
				}
				break;

			// append element
			case "append":
				var element = cwui.getById(cmd.data.id);
				var div = document.createElement("div");
				div.innerHTML = atob(cmd.data.element);
				div.id = cmd.data.childId;
				element.appendChild(div);
				break;

			// reload the style sheets
			case "reloadStyleSheets":
				cwui.reloadStyleSheets();
				break;

			// trigger a general window resize
			case "windowResize":
				window.dispatchEvent(new Event("resize"));
				break;

			// call custom routine
			case "call":
				if (cmd.data.params &amp;&amp; typeof cmd.data.params == 'string')
					cmd.data.params = JSON.parse(cmd.data.params);
				cwui._GetRoutine(cmd.data.name).fn((
													   cmd.data.params instanceof Array
													   &amp;&amp; cmd.data.params.length == 0) ?
												   [] : cmd.data.params,
												   (_params) => {
													   cwui.webSock.send(JSON.stringify(
														   {
															   "command": "onCallEnd",
															   "name"   : cmd.data.name,
															   "params" : _params ? _params : {}
														   }));
												   });
				break;

			// shutdown the communication
			case "shutdown":
				cwui.webSock.close();
				break;
			// unknown command
			default:
				console.warn("Unknown command: " + cmd.command, " data", cmd.data);
		}
	}

}

/**
 * execute mainCwui
 */
var CWUI = new mainCwui();
</code></pre></article></section></div><br class="clear"><footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Sat Sep 04 2021 10:29:09 GMT+0200 (heure d’été d’Europe centrale) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer><script>prettyPrint();</script><script src="scripts/polyfill.js"></script><script src="scripts/linenumber.js"></script><script src="scripts/search.js" defer></script><script src="scripts/collapse.js" defer></script></body></html>
